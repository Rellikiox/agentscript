(function(){var t,r,e,n,i,h={}.hasOwnProperty,o=function(t,r){function e(){this.constructor=t}for(var n in r)h.call(r,n)&&(t[n]=r[n]);return e.prototype=r.prototype,t.prototype=new e,t.__super__=r.prototype,t};i=ABM.util,ABM.DataSet=r=function(){function r(t,r,e){null==t&&(t=0),null==r&&(r=0),null==e&&(e=[]),this.useNearest=!1,this.reset(t,r,e)}return r.patchDataSet=function(t){return new n(t)},r.importImageDataSet=function(t,r,n,h){var o;return null==r&&(r=i.pixelByte(0)),null==n&&(n=Uint8ClampedArray),o=new e(null,r,n,h),i.importImage(t,function(t){return o.parse(t),null!=r?r(o):void 0}),o},r.importAscDataSet=function(r,e){var n;return n=new t,i.xhrLoadFile(r,"GET","text",function(t){return n.parse(t),null!=e?e(n):void 0}),n},r.prototype.reset=function(t,r,e){return this.width=t,this.height=r,this.data=e,e.length!==t*r&&i.error("DataSet: data array length error:\ndata.length: "+this.data.length+" width: "+this.width+" height: "+this.height),this},r.prototype.checkXY=function(t,r){return t>=0&&t<=this.width-1&&r>=0&&r<=this.height-1?void 0:i.error("x,y out of range: "+t+","+r)},r.prototype.setSampler=function(t){this.useNearest=t},r.prototype.sample=function(t,r){return this.useNearest?this.nearest(t,r):this.bilinear(t,r)},r.prototype.nearest=function(t,r){return this.getXY(Math.round(t),Math.round(r))},r.prototype.bilinear=function(t,r){var e,n,i,h,o,a,s,l,u,p,c,d,f;return this.checkXY(t,r),u=Math.floor(t),p=Math.floor(r),s=this.toIndex(u,p),l=this.width,t-=u,r-=p,e=1-t,n=1-r,i=this.data[s],h=null!=(c=this.data[s+l])?c:0,o=null!=(d=this.data[++s])?d:0,a=null!=(f=this.data[s+l])?f:0,i*e*n+o*t*n+h*e*r+a*t*r},r.prototype.toIndex=function(t,r){return t+r*this.width},r.prototype.toXY=function(t){return[t%this.width,Math.floor(t/this.width)]},r.prototype.getXY=function(t,r){return this.checkXY(t,r),this.data[this.toIndex(t,r)]},r.prototype.setXY=function(t,r,e){return this.checkXY(t,r),this.data[this.toIndex(t,r)]=e},r.prototype.toString=function(t,r){var e,n,h,o,a;for(null==t&&(t=2),null==r&&(r=", "),h="width: "+this.width+" height: "+this.height+" data:",e=0>t?this.data:i.aToFixed(this.data,t),n=o=0,a=this.height;a>=0?a>o:o>a;n=a>=0?++o:--o)h+="\n"+(""+n+": "+e.slice(n*this.width,(n+1)*this.width));return h.replace(/,/g,r)},r.prototype.toImage=function(t,r,e){return null==t&&(t=!0),null==r&&(r=!0),null==e&&(e=255),this.toContext(t,r,e).canvas},r.prototype.toContext=function(t,r,e){var n,h,o,a,s,l,u,p,c,d,f;for(null==t&&(t=!0),null==r&&(r=!0),null==e&&(e=255),n=i.createCtx(this.width,this.height),a=n.getImageData(0,0,this.width,this.height),c=a.data,l=Math.pow(2,t?8:24),u=r?i.normalize(this.data,0,l-1e-6):function(){var t,r,e,n;for(e=this.data,n=[],t=0,r=e.length;r>t;t++)h=e[t],n.push(i.clamp(Math.round(h),0,l-1));return n}.call(this),o=d=0,f=u.length;f>d;o=++d)p=u[o],s=4*o,c[s+3]=e,t?c[s]=c[s+1]=c[s+2]=Math.floor(p):(c[s]=p>>>16,c[s+1]=p>>8&255,c[s+2]=255&p);return n.putImageData(a,0,0),window.idata=a,window.ctx=n,n},r.prototype.toDrawing=function(t,r,e){var n;return null==t&&(t=!0),null==r&&(r=!0),null==e&&(e=255),ABM.patches.installDrawing(n=this.toImage(t,r,e)),n},r.prototype.toPatchColors=function(t,r,e){var n;return null==t&&(t=!0),null==r&&(r=!0),null==e&&(e=255),ABM.patches.installColors(n=this.toImage(t,r,e)),n},r.prototype.toPatchVar=function(t){var r,e,n,i,h,o,a;if((n=ABM.patches).length===this.data.length)for(r=i=0,o=n.length;o>i;r=++i)e=n[r],e[t]=this.data[r];else for(h=0,a=n.length;a>h;h++)e=n[h],e[t]=this.patchSample(e.x,e.y);return null},r.prototype.coordSample=function(t,r,e,n,i,h){var o,a;return o=(t-e)*(this.width-1)/i,a=(n-r)*(this.height-1)/h,this.sample(o,a)},r.prototype.patchSample=function(t,r){var e;return e=ABM.world,this.coordSample(t,r,e.minXcor,e.maxYcor,e.numX,e.numY)},r.prototype.resample=function(t,e){var n,i,h,o,a,s,l,u,p;if(t===this.width&&e===this.height)return new r(t,e,this.data);for(n=[],h=(this.width-1)/(t-1),s=(this.height-1)/(e-1),a=u=0;e>u;a=u+=1)for(i=p=0;t>p;i=p+=1)o=i*h,l=a*s,n.push(this.sample(o,l));return new r(t,e,n)},r.prototype.neighborhood=function(t,r,e){var n,h,o,a,s,l;for(null==e&&(e=[]),e.length=0,h=s=-1;1>=s;h=++s)for(n=l=-1;1>=l;n=++l)o=i.clamp(t+n,0,this.width-1),a=i.clamp(r+h,0,this.height-1),e.push(this.data[this.toIndex(o,a)]);return e},r.prototype.convolve=function(t,e){var n,h,o,a,s,l,u,p;for(null==e&&(e=1),n=[],h=[],a=s=0,u=this.height;u>s;a=s+=1)for(o=l=0,p=this.width;p>l;o=l+=1)this.neighborhood(o,a,h),n.push(i.aSum(i.aPairMul(t,h))*e);return new r(this.width,this.height,n)},r.prototype.dzdx=function(t,r){return null==t&&(t=2),null==r&&(r=1/8),this.convolve([-1,0,1,-t,0,t,-1,0,1],r)},r.prototype.dzdy=function(t,r){return null==t&&(t=2),null==r&&(r=1/8),this.convolve([1,t,1,0,0,0,-1,-t,-1],r)},r.prototype.laplace8=function(){return this.convolve([-1,-1,-1,-1,8,-1,-1,-1,-1])},r.prototype.laplace4=function(){return this.convolve([0,-1,0,-1,4,-1,0,-1,0])},r.prototype.slopeAndAspect=function(t,e){var n,h,o,a,s,l,u,p,c,d,f,g,w;for(null==t&&(t=!0),null==e&&(e=!0),h=this.dzdx(),o=this.dzdy(),n=[],u=[],c=d=0,g=this.height;g>d;c=d+=1)for(p=f=0,w=this.width;w>f;p=f+=1){for(a=h.getXY(p,c),s=o.getXY(p,c),u.push(Math.atan(Math.sqrt(a*a+s*s)));t&&a===s;)a+=i.randomNormal(0,1e-4),s+=i.randomNormal(0,1e-4);l=a===s&&0===s?0/0:Math.atan2(-s,-a),e&&0>l&&(l+=2*Math.PI),n.push(l)}return u=new r(this.width,this.height,u),n=new r(this.width,this.height,n),[u,n,h,o]},r.prototype.subset=function(t,e,n,h){var o,a,s,l,u,p,c;for((t+n>this.width||e+h>this.height)&&i.error("subSet: params out of range"),o=[],s=l=e,p=e+h;p>l;s=l+=1)for(a=u=t,c=t+n;c>u;a=u+=1)o.push(this.getXY(a,s));return new r(n,h,o)},r}(),ABM.AscDataSet=t=function(t){function r(t){this.str=null!=t?t:"",r.__super__.constructor.call(this),0!==this.str.length&&this.parse(this.str)}return o(r,t),r.prototype.parse=function(t){var r,e,n,i,h,o,a,s,l;for(this.str=t,i=t.split("\n"),this.header={},r=h=0;5>=h;r=++h)e=i[r].split(/\s+/),this.header[e[0].toLowerCase()]=parseFloat(e[1]);for(r=o=0,s=this.header.nrows;s>o;r=o+=1){for(n=i[6+r].trim().split(" "),r=a=0,l=n.length;l>=0?l>a:a>l;r=l>=0?++a:--a)n[r]=parseFloat(n[r]);this.data=this.data.concat(n)}return this.reset(this.header.ncols,this.header.nrows,this.data)},r}(r),ABM.ImageDataSet=e=function(t){function r(t,e,n,h){this.f=null!=e?e:i.pixelByte(0),this.arrayType=null!=n?n:Uint8ClampedArray,this.rowsPerSlice=h,r.__super__.constructor.call(this),null!=t&&this.parse(t)}return o(r,t),r.prototype.parse=function(t){var r;return this.rowsPerSlice||(this.rowsPerSlice=t.height),r=i.imageRowsToData(t,this.rowsPerSlice,this.f,this.arrayType),this.reset(t.width,t.height,r)},r}(r),ABM.PatchDataSet=n=function(t){function r(t,e){var n,h,o,a,s,l;for(null==e&&(e=Array),n=new e((a=ABM.patches).length),i.isString(t)&&(t=i.propFcn(t)),h=s=0,l=a.length;l>s;h=++s)o=a[h],n[h]=t(o);r.__super__.constructor.call(this,a.numX,a.numY,n),this.useNearest=!0}return o(r,t),r.prototype.toPatchVar=function(t){var r,e,n,i,h;for(h=ABM.patches,r=n=0,i=h.length;i>n;r=++n)e=h[r],e[t]=this.data[r];return null},r}(r)}).call(this);